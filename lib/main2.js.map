{
  "version": 3,
  "file": "",
  "sourceRoot": "",
  "sources": [
    "../src/main2.coffee"
  ],
  "names": [],
  "mappings": "AACA;EAAA;AAAA,MAAA,GAAA,EAAA,GAAA,EAAA,IAAA,EAAA,IAAA,EAAA,GAAA,EAAA,GAAA,EAAA,KAAA,EAAA,KAAA,EAAA,IAAA,EAAA,IAAA,EAAA,IAAA,EAAA,GAAA,EAAA,GAAA,EAAA,OAAA,EAAA,KAAA,EAAA,IAAA,EAAA,QAAA,EAAA,gBAAA,EAAA,IAAA,EAAA,OAAA;;;EAIA,GAAA,GAA4B,OAAA,CAAQ,KAAR;;EAC5B,GAAA,GAA4B,GAAG,CAAC;;EAChC,KAAA,GAA4B;;EAC5B,KAAA,GAA4B,GAAG,CAAC,UAAJ,CAAe,OAAf,EAA4B,KAA5B;;EAC5B,IAAA,GAA4B,GAAG,CAAC,UAAJ,CAAe,MAAf,EAA4B,KAA5B;;EAC5B,IAAA,GAA4B,GAAG,CAAC,UAAJ,CAAe,MAAf,EAA4B,KAA5B;;EAC5B,IAAA,GAA4B,GAAG,CAAC,UAAJ,CAAe,MAAf,EAA4B,KAA5B;;EAC5B,IAAA,GAA4B,GAAG,CAAC,UAAJ,CAAe,MAAf,EAA4B,KAA5B;;EAC5B,OAAA,GAA4B,GAAG,CAAC,UAAJ,CAAe,SAAf,EAA4B,KAA5B;;EAC5B,IAAA,GAA4B,GAAG,CAAC,IAAI,CAAC,IAAT,CAAc,GAAd,EAb5B;;;EAeA,IAAA,GAA4B,OAAA,CAAQ,MAAR;;EAC5B,KAAA,GAA4B,IAAI,CAAE,OAAA,CAAQ,WAAR,CAAF,CAAuB,CAAC,SAA5B,CAAA;;EAC5B,CAAA,CAAE,GAAF,EACE,OADF,EAEE,QAFF,EAGE,gBAHF,CAAA,GAG4B,KAAK,CAAC,MAAN,CAAA,CAH5B;;EAIA,GAAA,GAA4B,MAAM,CAAC;;EACnC,GAAA,GAA4B,OAAA,CAAQ,KAAR;;EAC5B,CAAA;IAAE,OAAA,EAAS;EAAX,CAAA,GAA4B,OAAA,CAAQ,WAAR,CAA5B;;EACA,GAAA,GAA4B,OAAA,CAAQ,KAAR,EAxB5B;;;EA4BA,KAAK,CAAC,OAAN,CAAc,iBAAd,EAAiC;IAAA,KAAA,EAC/B;MAAA,eAAA,EAAkD,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,GAAG,CAAC,MAAL,CAAY,CAAZ;MAAT,CAAlD;MACA,+CAAA,EAAkD,QAAA,CAAE,CAAF,CAAA;eAAS,CAAE,IAAC,CAAA,GAAG,CAAC,MAAL,CAAY,CAAC,CAAC,EAAd,CAAF,CAAA,IAAwB,CAAE,IAAC,CAAA,GAAG,CAAC,QAAL,CAAc,CAAC,CAAC,EAAhB,CAAF;MAAjC;IADlD;EAD+B,CAAjC,EA5BA;;;EAiCA,KAAK,CAAC,OAAN,CAAc,4BAAd,EAA4C;IAAA,KAAA,EAC1C;MAAA,eAAA,EAAgC,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,GAAG,CAAC,MAAL,CAAY,CAAZ;MAAT,CAAhC;MACA,0BAAA,EAAgC,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,GAAG,CAAC,aAAL,CAAmB,CAAC,CAAC,GAArB;MAAT,CADhC;MAEA,sBAAA,EAAgC,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,GAAG,CAAC,OAAL,CAAa,CAAC,CAAC,KAAf;MAAT;IAFhC;EAD0C,CAA5C,EAjCA;;;EAuCA,KAAK,CAAC,OAAN,CAAc,uBAAd,EAAuC;IAAA,KAAA,EACrC;MAAA,eAAA,EAAgC,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,GAAG,CAAC,MAAL,CAAY,CAAZ;MAAT,CAAhC;MACA,0BAAA,EAAgC,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,GAAG,CAAC,aAAL,CAAmB,CAAC,CAAC,GAArB;MAAT,CADhC;MAEA,kBAAA,EAAgC,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,GAAG,CAAC,IAAL,CAAU,CAAC,CAAC,IAAZ;MAAT,CAFhC;MAGA,mBAAA,EAAgC,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,GAAG,CAAC,OAAL,CAAa,CAAC,CAAC,EAAf;MAAT;IAHhC;EADqC,CAAvC,EAvCA;;;EA8CA,KAAK,CAAC,OAAN,CAAc,wBAAd,EAAwC;IAAA,KAAA,EACtC;MAAA,eAAA,EAAsC,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,GAAG,CAAC,MAAL,CAAY,CAAZ;MAAT,CAAtC;MACA,0BAAA,EAAsC,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,GAAG,CAAC,aAAL,CAAmB,CAAC,CAAC,GAArB;MAAT;IADtC;EADsC,CAAxC,EA9CA;;;EAmDA,KAAK,CAAC,OAAN,CAAc,uBAAd,EAAuC;IAAA,KAAA,EACrC;MAAA,eAAA,EAAsC,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,GAAG,CAAC,MAAL,CAAY,CAAZ;MAAT,CAAtC;MACA,0BAAA,EAAsC,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,GAAG,CAAC,aAAL,CAAmB,CAAC,CAAC,GAArB;MAAT;IADtC;EADqC,CAAvC,EAnDA;;;EAwDA,KAAK,CAAC,OAAN,CAAc,oBAAd,EAAoC;IAAA,KAAA,EAClC;MAAA,eAAA,EAAsC,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,GAAG,CAAC,MAAL,CAAY,CAAZ;MAAT,CAAtC;MACA,0BAAA,EAAsC,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,GAAG,CAAC,aAAL,CAAmB,CAAC,CAAC,GAArB;MAAT,CADtC;MAEA,6BAAA,EAAsC,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,YAAY,CAAC,OAAd,CAAsB,CAAC,CAAC,GAAxB;MAAT,CAFtC;MAGA,6BAAA,EAAsC,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,YAAY,CAAC,OAAd,CAAsB,CAAC,CAAC,GAAxB;MAAT,CAHtC;MAIA,6BAAA,EAAsC,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,YAAY,CAAC,OAAd,CAAsB,CAAC,CAAC,GAAxB;MAAT;IAJtC;EADkC,CAApC,EAxDA;;;EAgEA,KAAK,CAAC,OAAN,CAAc,sBAAd,EAAsC;IAAA,KAAA,EACpC;MAAA,eAAA,EAA4C,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,GAAG,CAAC,MAAL,CAAY,CAAZ;MAAT,CAA5C;MACA,yCAAA,EAA4C,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,YAAY,CAAC,kBAAd,CAAiC,CAAC,CAAC,IAAnC;MAAT,CAD5C;MAEA,qCAAA,EAA4C,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,YAAY,CAAC,eAAd,CAA8B,CAAC,CAAC,GAAhC;MAAT,CAF5C;MAGA,wCAAA,EAA4C,QAAA,CAAE,CAAF,CAAA;eAAS,CAAE,gBAAA,IAAW,eAAb,CAAA,IAA0B,CAAI,CAAE,gBAAA,IAAY,eAAd;MAAvC;IAH5C;EADoC,CAAtC,EAhEA;;;EAuEA,KAAK,CAAC,OAAN,CAAc,oBAAd,EAAoC;IAAA,KAAA,EAClC;MAAA,aAAA,EAAwB,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,GAAG,CAAC,IAAL,CAAU,CAAV;MAAT,CAAxB;MACA,kBAAA,EAAwB,QAAA,CAAE,CAAF,CAAA;eAAS,CAAC,CAAC,UAAF,CAAa,GAAb;MAAT;IADxB;EADkC,CAApC,EAvEA;;;EA4EA,KAAK,CAAC,OAAN,CAAc,iBAAd,EAAiC;IAAA,KAAA,EAC/B;MAAA,aAAA,EAAwC,QAAA,CAAE,CAAF,CAAA;eAAS,IAAC,CAAA,GAAG,CAAC,IAAL,CAAU,CAAV;MAAT,CAAxC;MACA,qCAAA,EAAwC,QAAA,CAAE,CAAF,CAAA;eAAW,sBAAwB,CAAC,IAA3B,CAAgC,CAAhC;MAAT;IADxC;EAD+B,CAAjC,EA5EA;;;EAmFM,IAAC,CAAA;IAAP,MAAA,IAAA,CAAA;;MAqCE,WAAa,CAAE,GAAF,CAAA;AACf,YAAA;QAAI,IAAC,CAAA,GAAD,GAAU,CAAE,GAAA,IAAC,CAAA,WAAW,CAAC,CAAC,CAAC,QAAQ,CAAC,eAA1B,EAA8C,GAAA,GAA9C;QACV,GAAG,CAAC,KAAK,CAAC,IAAV,CAAe,IAAf,EAAkB,OAAlB,EAA2B,KAA3B;QACA,IAAC,CAAA,KAAK,CAAC,QAAQ,CAAC,eAAhB,CAAgC,IAAC,CAAA,GAAjC;QACA,CAAA,CAAE,EAAF,CAAA,GAAU,GAAG,CAAC,GAAG,CAAC,mBAAR,CAA4B,IAAC,CAAA,GAA7B,EAAkC,IAAlC,EAAwC,IAAxC,CAAV;QACA,GAAG,CAAC,KAAK,CAAC,IAAV,CAAe,IAAf,EAAkB,IAAlB,EAAwB,EAAxB;QACA,IAAC,CAAA,GAAD,GAAU,GAAG,CAAC,GAAG,CAAC,MAAR,CAAe,IAAC,CAAA,GAAhB;QACV,IAAC,CAAA,EAAE,CAAC,aAAJ,CAAA;;UACA,IAAC,CAAA;;;UACD,IAAC,CAAA;;;UACD,IAAC,CAAA;;;UACD,IAAC,CAAA;;AACD,eAAO;MAZI,CAnCf;;;MAkDE,cAAgB,CAAA,CAAA,EAAA,CAlDlB;;;MAqDE,qBAAuB,CAAA,CAAA;AACzB,YAAA;QAAI,CAAA,CAAE,MAAF,CAAA,GAAa,IAAC,CAAA,GAAd,EAAJ;;QAEI,IAAC,CAAA,EAAE,CAAC,eAAJ,CACE;UAAA,IAAA,EAAgB,MAAA,GAAS,cAAzB;UACA,aAAA,EAAgB,IADhB;UAEA,OAAA,EAAgB,KAFhB;UAGA,IAAA,EAAgB,QAAA,CAAE,GAAF,CAAA;YAAW,IAAK,OAAO,CAAC,IAAR,CAAa,GAAb,CAAL;qBAA6B,EAA7B;aAAA,MAAA;qBAAoC,EAApC;;UAAX;QAHhB,CADF,EAFJ;;AAQI,eAAO;MATc,CArDzB;;;MAiEE,uBAAyB,CAAA,CAAA,EAAA;;AAC3B,YAAA;QACI,CAAA,CAAE,MAAF,CAAA,GAAa,IAAC,CAAA,GAAd;QACA,IAAC,CAAA,EAAD,CAAI,GAAG,CAAA,sBAAA,CAAA,CACmB,MADnB,CAAA;sBAAA,CAAA,CAEmB,MAFnB,CAAA;sBAAA,CAAA,CAGmB,MAHnB,CAAA;sBAAA,CAAA,CAImB,MAJnB,CAAA;sBAAA,CAAA,CAKmB,MALnB,CAAA;sBAAA,CAAA,CAMmB,MANnB,CAAA;sBAAA,CAAA,CAOmB,MAPnB,CAAA;sBAAA,CAAA,CAQmB,MARnB,CAAA;sBAAA,CAAA,CASmB,MATnB,CAAA,aAAA,CAAP,EAFJ;;;;QAeI,IAAC,CAAA,EAAD,CAAI,GAAG,CAAA,aAAA,CAAA,CACU,MADV,CAAA;;;;;wBAAA,CAAP,EAfJ;;;QAwBI,IAAC,CAAA,EAAD,CAAI,GAAG,CAAA;;aAAA,CAAA,CAGU,MAHV,CAAA;;;;;;;UAAA,CAAA,CAUO,MAVP,CAAA;;iCAAA,CAAA,CAY8B,MAZ9B,CAAA;uCAAA,CAAP,EAxBJ;;QAuCI,IAAC,CAAA,EAAD,CAAI,GAAG,CAAA;YAAA,CAAA,CAES,MAFT,CAAA;;;OAAA,CAAA,CAKI,MALJ,CAAA;;;8BAAA,CAAP,EAvCJ;;QAiDI,IAAC,CAAA,EAAD,CAAI,GAAG,CAAA;;;YAAA,CAAA,CAIS,MAJT,CAAA;;;OAAA,CAAA,CAOI,MAPJ,CAAA;;;eAAA,CAAP,EAjDJ;;QA6DI,IAAC,CAAA,EAAD,CAAI,GAAG,CAAA;YAAA,CAAA,CAES,MAFT,CAAA;;;;;OAAA,CAAA,CAOI,MAPJ,CAAA;;gBAAA,CAAP,EA7DJ;;QAwEI,IAAC,CAAA,EAAD,CAAI,GAAG,CAAA;YAAA,CAAA,CAES,MAFT,CAAA;;;;;;;;;aAAA,CAAA,CAWU,MAXV,CAAA;;;OAAA,CAAA,CAcI,MAdJ,CAAA;eAAA,CAAP,EAxEJ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;QA6HI,IAAC,CAAA,EAAD,CAAI,GAAG,CAAA,eAAA,CAAA,CACY,MADZ,CAAA,0CAAA,CAAA,CAC+D,MAD/D,CAAA;;;yDAAA,CAAA,CAIsD,MAJtD,CAAA;QAAA,CAAP;QAMA,IAAC,CAAA,EAAD,CAAI,GAAG,CAAA,eAAA,CAAA,CACY,MADZ,CAAA,0CAAA,CAAA,CAC+D,MAD/D,CAAA;;;yDAAA,CAAA,CAIsD,MAJtD,CAAA;QAAA,CAAP;QAMA,IAAC,CAAA,EAAD,CAAI,GAAG,CAAA,eAAA,CAAA,CACY,MADZ,CAAA,0CAAA,CAAA,CAC+D,MAD/D,CAAA;;;yDAAA,CAAA,CAIsD,MAJtD,CAAA;QAAA,CAAP,EAzIJ;;AAgJI,eAAO;MAjJgB,CAjE3B;;;MAqNE,YAAc,CAAA,CAAA;AAChB,YAAA;QAAI,CAAA,CAAE,MAAF,CAAA,GAAa,IAAC,CAAA,GAAd,EAAJ;;QAEI,GAAG,CAAC,KAAK,CAAC,IAAV,CAAe,IAAf,EAAkB,KAAlB,EAEE,CAAA;;UAAA,mBAAA,EAAsB,GAAG,CAAA,uFAAA,CAAzB;;UAGA,iBAAA,EAAoB,GAAG,CAAA,cAAA,CAAA,CACL,MADK,CAAA,8BAAA,CAHvB;;UAMA,aAAA,EAAe,GAAG,CAAA,OAAA,CAAA,CACP,MADO,CAAA,mDAAA,CANlB;;UASA,YAAA,EAAc,GAAG,CAAA,YAAA,CAAA,CACD,MADC,CAAA,yBAAA,CATjB;;UAYA,iBAAA,EAAmB,IAAC,CAAA,EAAE,CAAC,aAAJ,CAAkB;YACnC,IAAA,EAAQ,MAAA,GAAS,cADkB;YAEnC,MAAA,EAAQ,CAAE,KAAF,EAAS,MAAT,EAAiB,KAAjB,CAF2B;YAGnC,WAAA,EAAa;cAAE,MAAA,EAAQ;YAAV;UAHsB,CAAlB,CAZnB;;UAiBA,WAAA,EAAa,IAAC,CAAA,EAAE,CAAC,aAAJ,CAAkB;YAC7B,IAAA,EAAY,MAAA,GAAS,SADQ;YAE7B,MAAA,EAAY,CAAE,KAAF,EAAS,KAAT,EAAgB,KAAhB;UAFiB,CAAlB,CAjBb;;UAqBA,aAAA,EAAe,IAAC,CAAA,EAAE,CAAC,aAAJ,CAAkB;YAC/B,IAAA,EAAY,MAAA,GAAS,SADU;YAE/B,MAAA,EAAY,CAAE,KAAF,EAAS,KAAT,EAAgB,KAAhB,EAAuB,KAAvB,EAA8B,KAA9B;UAFmB,CAAlB,CArBf;;UAyBA,WAAA,EAAa,IAAC,CAAA,EAAE,CAAC,aAAJ,CAAkB;YAC7B,IAAA,EAAY,MAAA,GAAS,SADQ;YAE7B,MAAA,EAAY,CAAE,KAAF,EAAS,KAAT,EAAgB,KAAhB,EAAuB,MAAvB,EAA+B,KAA/B,CAFiB;YAG7B,SAAA,EAAY;UAHiB,CAAlB,CAzBb;;UA8BA,2BAAA,EAA6B,GAAG,CAAA;;YAAA,CAAA,CAGhB,MAHgB,CAAA;;;;;;;;;;SAAA,CAAA,CAanB,MAbmB,CAAA;cAAA,CA9BhC;;UA8CA,YAAA,EAAc,IAAC,CAAA,EAAE,CAAC,aAAJ,CAAkB;YAC9B,IAAA,EAAY,MAAA,GAAS,OADS;YAE9B,MAAA,EAAY,CAAE,KAAF,EAAS,KAAT,EAAgB,KAAhB,EAAuB,OAAvB,EAAgC,KAAhC;UAFkB,CAAlB;QA9Cd,CAFF,EAFJ;;AAsDI,eAAO;MAvDK,CArNhB;;;MA+QE,YAAc,CAAE,GAAF,CAAA;QACZ,QAAQ,CAAC,oBAAT,CAA8B,GAA9B;QACA,IAAG,gBAAH;UAAgD,GAAG,CAAC,GAAJ,GAAY,IAAC,CAAA,cAAD,CAAgB,GAAG,CAAC,IAApB,EAA5D;SAAA,MACK,IAAG,IAAC,CAAA,KAAK,CAAC,GAAG,CAAC,YAAX,CAAwB,GAAG,CAAC,GAA5B,CAAH;UAA2C,GAAG,CAAC,IAAJ,GAAY,IAAC,CAAA,cAAD,CAAgB,GAAG,CAAC,GAApB,EAAvD;SAAA,MAAA;UAC2C,GAAG,CAAC,IAAJ,GAAY,KADvD;;QAEL,IAAC,CAAA,EAAD,CAAI,IAAC,CAAA,GAAG,CAAC,iBAAT,EAA4B,GAA5B;AACA,eAAO;MANK,CA/QhB;;;MAwRE,kBAAoB,CAAE,GAAF,CAAA;eAAW,IAAC,CAAA,EAAE,CAAC,UAAJ,CAAe,IAAC,CAAA,GAAG,CAAC,iBAApB,EAAuC,CAAE,GAAF,CAAvC;MAAX;;MACpB,cAAgB,CAAE,GAAF,EAAO,MAAP,CAAA;eAAmB,IAAC,CAAA,EAAD,CAAI,IAAC,CAAA,GAAG,CAAC,aAAT,EAAwB,CAAE,GAAF,EAAO,MAAP,CAAxB;MAAnB;;MAChB,aAAe,CAAE,GAAF,CAAA;eAAW,IAAC,CAAA,EAAD,CAAI,IAAC,CAAA,GAAG,CAAC,YAAT,EAAuB,CAAE,GAAF,CAAvB;MAAX,CA1RjB;;;MA6RE,cAAgB,CAAE,IAAF,CAAA;QACd,QAAQ,CAAC,kBAAT,CAA4B,IAA5B;AACA,eAAO,CAAE,GAAG,CAAC,aAAJ,CAAkB,IAAlB,CAAF,CAA0B,CAAC;MAFpB,CA7RlB;;;MAkSE,cAAgB,CAAE,GAAF,CAAA;AACd,eAAO,GAAG,CAAC,aAAJ,CAAkB,GAAlB;MADO,CAlSlB;;;MAsSE,kBAAoB,CAAE,GAAF,CAAA;AACtB,YAAA;QAAI,IAAC,CAAA,EAAE,CAAC,IAAJ,CAAS,wBAAT,EAAmC,CAAnC;AACA;UACE,CAAA,GAAI,IAAC,CAAA,mBAAD,CAAqB,GAArB,EADN;SAAA;UAGE,IAAC,CAAA,EAAE,CAAC,IAAJ,CAAS,wBAAT,EAAmC,CAAnC,EAHF;;AAIA,eAAO;MANW,CAtStB;;;MA+SE,mBAAqB,CAAE,GAAF,CAAA;AACvB,YAAA,MAAA,EAAA,cAAA,EAAA,MAAA,EAAA,GAAA,EAAA,KAAA,EAAA,IAAA,EAAA,MAAA,EAAA;QAAI,QAAQ,CAAC,0BAAT,CAAoC,CAAE,GAAA,GAAM,CAAE,GAAA,IAAC,CAAA,WAAW,CAAC,CAAC,CAAC,QAAQ,CAAC,0BAA1B,EAAyD,GAAA,GAAzD,CAAR,CAApC;QACA,CAAA,CAAE,GAAF,EACE,KADF,CAAA,GACkB,GADlB;QAEA,CAAA,CAAE,MAAF,CAAA,GAAkB,IAAC,CAAA,GAAnB;QACA,CAAA,CAAE,IAAF,EACE,GADF,EAEE,MAFF,CAAA,GAEkB,IAAC,CAAA,kBAAD,CAAoB,GAApB,CAFlB;QAGA,IAAO,YAAP;UACE,MAAM,IAAI,KAAJ,CAAU,CAAA,2DAAA,CAAA,CAA8D,GAAA,CAAI,GAAJ,CAA9D,CAAA,OAAA,CAAA,CAA+E,GAAA,CAAI,GAAJ,CAA/E,CAAA,CAAA,CAAV,EADR;;QAEA,cAAA,GAAkB,GAAG,CAAC,EAAE,CAAC,gBAAP,CAAwB,IAAxB;QAClB,MAAA,GAAkB;UAAE,KAAA,EAAO,CAAT;UAAY,KAAA,EAAO;QAAnB,EAVtB;;QAYI,IAAG,KAAA,IAAS,CAAE,MAAA,KAAY,cAAd,CAAZ;;UAEE,IAAC,CAAA,EAAD,CAAI,CAAA,CAAA,GAAA;AACV,gBAAA,WAAA,EAAA,IAAA,EAAA,GAAA,EAAA,GAAA,EAAA;YAAQ,IAAC,CAAA,aAAD,CAAe,GAAf;YACA,WAAA,GAAgB,IAAC,CAAA,EAAE,CAAC,OAAJ,CAAY,IAAC,CAAA,GAAG,CAAC,WAAjB;YAChB,GAAA,GAAgB;AAEhB;;;;YAAA,KAAA,WAAA;cACE,GAAA;cACA,MAAM,CAAC,KAAP,IAAkB,IAAI,CAAC;cACvB,GAAA,GAAkB,IAAI,CAAC,QAAL,CAAc,OAAd;cAClB,WAAW,CAAC,GAAZ,CAAgB,CAAE,GAAF,EAAO,GAAP,EAAY,GAAZ,CAAhB;YAJF,CAJR;;YAUQ,MAAM,CAAC,KAAP;YACA,IAAC,CAAA,cAAD,CAAgB,GAAhB,EAAqB,cAArB;AACA,mBAAO;UAbL,CAAJ,EAFF;SAZJ;;AA6BI,eAAO;MA9BY,CA/SvB;;;;;MAmVE,QAAgB,CAAE,GAAF,CAAA;AAAU,YAAA;eAAC;;AAAE;AAAA;UAAA,KAAA,QAAA;yBAAA,CAAC,CAAC;UAAF,CAAA;;qBAAF,CAAyC,CAAC,IAA1C,CAA+C,IAA/C;MAAX;;MAChB,aAAgB,CAAE,GAAF,CAAA;eAAW,CAAE,GAAA,CAAE,IAAC,CAAA,cAAD,CAAgB,GAAhB,CAAF,CAAF;MAAX,CApVlB;;;MAuVE,cAAgB,CAAE,GAAF,CAAA;AAClB,YAAA,GAAA,EAAA;QAAI,QAAQ,CAAC,sBAAT,CAAgC,CAAE,GAAA,GAAM,CAAE,GAAA,IAAC,CAAA,WAAW,CAAC,CAAC,CAAC,QAAQ,CAAC,sBAA1B,EAAqD,GAAA,GAArD,CAAR,CAAhC;QACA,CAAA,CAAE,GAAF,CAAA,GAAgB,GAAhB;QACA,CAAA,CAAE,MAAF,CAAA,GAAgB,IAAC,CAAA,GAAjB;QACA,IAAC,CAAA,EAAE,CAAC,IAAJ,CAAS,KAAT,EAAsB,GAAtB;AACA,eAAO,IAAC,CAAA,EAAD,CAAI,GAAG,CAAA,cAAA,CAAA,CAAiB,MAAjB,CAAA,OAAA,CAAP;MALO,CAvVlB;;;MA+VE,aAAe,CAAE,GAAF,CAAA;AACjB,YAAA,GAAA,EAAA;QAAI,QAAQ,CAAC,qBAAT,CAA+B,CAAE,GAAA,GAAM,CAAE,GAAA,IAAC,CAAA,WAAW,CAAC,CAAC,CAAC,QAAQ,CAAC,qBAA1B,EAAoD,GAAA,GAApD,CAAR,CAA/B;QACA,CAAA,CAAE,GAAF,CAAA,GAAgB,GAAhB;QACA,CAAA,CAAE,MAAF,CAAA,GAAgB,IAAC,CAAA,GAAjB;QACA,IAAC,CAAA,EAAE,CAAC,IAAJ,CAAS,KAAT,EAAsB,GAAtB;AACA,eAAO,IAAC,CAAA,EAAD,CAAI,GAAG,CAAA,cAAA,CAAA,CAAiB,MAAjB,CAAA,MAAA,CAAP;MALM,CA/VjB;;;MAuWE,QAAY,CAAE,GAAF,CAAA;eAAW,IAAC,CAAA,WAAD,CAAa;UAAE,GAAA,GAAF;UAAU,GAAA,EAAK;QAAf,CAAb;MAAX;;MACZ,UAAY,CAAE,GAAF,CAAA;eAAW,IAAC,CAAA,WAAD,CAAa;UAAE,GAAA,GAAF;UAAU,GAAA,EAAK;QAAf,CAAb;MAAX,CAxWd;;;MA2WE,WAAa,CAAE,GAAF,CAAA;AACf,YAAA,GAAA,EAAA,GAAA,EAAA,GAAA,EAAA,GAAA,EAAA,GAAA,EAAA;QAAI,QAAQ,CAAC,kBAAT,CAA4B,CAAE,GAAA,GAAM,CAAE,GAAA,IAAC,CAAA,WAAW,CAAC,CAAC,CAAC,QAAQ,CAAC,kBAA1B,EAAiD,GAAA,GAAjD,CAAR,CAA5B;QACA,CAAA,CAAE,GAAF,EACE,GADF,EAEE,GAFF,EAGE,GAHF,EAIE,GAJF,CAAA,GAIU,GAJV;QAKA,GAAA,GAAa,GAAH,GAAY,CAAZ,GAAmB;QAC7B,GAAA,GAAU,GAAG,CAAA,qDAAA;QACb,IAAsC,WAAtC;UAAA,GAAA,IAAU,GAAG,CAAA,mBAAA,EAAb;;QACA,IAAsC,WAAtC;UAAA,GAAA,IAAU,GAAG,CAAA,mBAAA,EAAb;;QACA,IAAsC,WAAtC;UAAA,GAAA,IAAU,GAAG,CAAA,mBAAA,EAAb;;QACA,GAAA,IAAU,GAAG,EAAA;QACb,CAAE,IAAC,CAAA,EAAE,CAAC,OAAJ,CAAY,GAAZ,CAAF,CAAmB,CAAC,GAApB,CAAwB,CAAE,GAAF,EAAO,GAAP,EAAY,GAAZ,EAAiB,GAAjB,EAAsB,GAAtB,CAAxB;AACA,eAAO;MAdI;;IA7Wf;;;IAGE,GAAC,CAAA,CAAD,GAAI,GAAG,CAAC,GAAG,CAAC,MAAR,CACF;MAAA,QAAA,EAEE,CAAA;;QAAA,eAAA,EACE;UAAA,EAAA,EAAkB,IAAlB;UACA,MAAA,EAAkB;QADlB,CADF;;QAIA,0BAAA,EACE;UAAA,GAAA,EAAkB,IAAlB;UACA,KAAA,EAAkB;QADlB,CALF;;QAQA,qBAAA,EACE;UAAA,GAAA,EAAkB,IAAlB;UACA,IAAA,EAAkB,IADlB;UAEA,EAAA,EAAkB;QAFlB,CATF;;QAaA,sBAAA,EACE;UAAA,GAAA,EAAkB;QAAlB,CAdF;;QAgBA,qBAAA,EACE;UAAA,GAAA,EAAkB;QAAlB,CAjBF;;QAmBA,oBAAA,EACE;UAAA,GAAA,EAAkB,IAAlB;UACA,IAAA,EAAkB,IADlB;UAEA,GAAA,EAAkB;QAFlB,CApBF;;QAwBA,kBAAA,EACE;UAAA,GAAA,EAAkB,IAAlB;UACA,GAAA,EAAkB,IADlB;UAEA,GAAA,EAAkB,IAFlB;UAGA,GAAA,EAAkB;QAHlB;MAzBF;IAFF,CADE;;;;;;EAtFN;;;;;AAAA",
  "sourcesContent": [
    "\n'use strict'\n\n\n############################################################################################################\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = 'DBAY-MIRAGE'\ndebug                     = CND.get_logger 'debug',     badge\nwarn                      = CND.get_logger 'warn',      badge\ninfo                      = CND.get_logger 'info',      badge\nurge                      = CND.get_logger 'urge',      badge\nhelp                      = CND.get_logger 'help',      badge\nwhisper                   = CND.get_logger 'whisper',   badge\necho                      = CND.echo.bind CND\n#...........................................................................................................\nPATH                      = require 'path'\ntypes                     = new ( require 'intertype' ).Intertype()\n{ isa\n  type_of\n  validate\n  validate_list_of }      = types.export()\nSQL                       = String.raw\nGUY                       = require 'guy'\n{ HTMLISH: ITXH }         = require 'intertext'\nURL                       = require 'url'\n\n\n#===========================================================================================================\ntypes.declare 'constructor_cfg', tests:\n  \"@isa.object x\":                                  ( x ) -> @isa.object x\n  \"( @isa.object x.db ) or ( @isa.function x.db \":  ( x ) -> ( @isa.object x.db ) or ( @isa.function x.db )\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.declare 'mrg_refresh_datasource_cfg', tests:\n  \"@isa.object x\":                ( x ) -> @isa.object x\n  \"@isa.nonempty_text x.dsk\":     ( x ) -> @isa.nonempty_text x.dsk\n  \"@isa.boolean x.force\":         ( x ) -> @isa.boolean x.force\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.declare 'mrg_append_to_loc_cfg', tests:\n  \"@isa.object x\":                ( x ) -> @isa.object x\n  \"@isa.nonempty_text x.dsk\":     ( x ) -> @isa.nonempty_text x.dsk\n  \"@isa.text x.text\":             ( x ) -> @isa.text x.text\n  \"@isa.boolean x.nl\":            ( x ) -> @isa.boolean x.nl\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.declare 'mrg_walk_line_rows_cfg', tests:\n  \"@isa.object x\":                      ( x ) -> @isa.object x\n  \"@isa.nonempty_text x.dsk\":           ( x ) -> @isa.nonempty_text x.dsk\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.declare 'mrg_walk_par_rows_cfg', tests:\n  \"@isa.object x\":                      ( x ) -> @isa.object x\n  \"@isa.nonempty_text x.dsk\":           ( x ) -> @isa.nonempty_text x.dsk\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.declare 'mrg_set_active_cfg', tests:\n  \"@isa.object x\":                      ( x ) -> @isa.object x\n  \"@isa.nonempty_text x.dsk\":           ( x ) -> @isa.nonempty_text x.dsk\n  \"@isa_optional.integer x.oln\":        ( x ) -> @isa_optional.integer x.oln\n  \"@isa_optional.integer x.trk\":        ( x ) -> @isa_optional.integer x.trk\n  \"@isa_optional.integer x.pce\":        ( x ) -> @isa_optional.integer x.pce\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.declare 'mrg_register_dsk_cfg', tests:\n  \"@isa.object x\":                            ( x ) -> @isa.object x\n  \"@isa_optional.mrg_fspath_for_url x.path\":  ( x ) -> @isa_optional.mrg_fspath_for_url x.path\n  \"@isa_optional.mrg_url_for_dsk x.url\":      ( x ) -> @isa_optional.mrg_url_for_dsk x.url\n  \"exactly 1 of x.path, x.url must be set\":   ( x ) -> ( x.path? or x.url? ) and not ( x.path? and x.url? )\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.declare 'mrg_fspath_for_url', tests:\n  \"@isa.text x\":          ( x ) -> @isa.text x\n  \"x.startsWith '/'\":     ( x ) -> x.startsWith '/'\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.declare 'mrg_url_for_dsk', tests:\n  \"@isa.text x\":                          ( x ) -> @isa.text x\n  \"( /^(file:\\/\\/\\/)|(live:)/ ).test x\":  ( x ) -> ( /^(file:\\/\\/\\/|live:)/ ).test x\n\n\n\n#===========================================================================================================\nclass @Mrg\n\n  #---------------------------------------------------------------------------------------------------------\n  @C: GUY.lft.freeze\n    defaults:\n      #.....................................................................................................\n      constructor_cfg:\n        db:               null\n        prefix:           'mrg'\n      #.....................................................................................................\n      mrg_refresh_datasource_cfg:\n        dsk:              null\n        force:            false\n      #.....................................................................................................\n      mrg_append_to_loc_cfg:\n        dsk:              null\n        text:             null\n        nl:               true\n      #.....................................................................................................\n      mrg_walk_line_rows_cfg:\n        dsk:              null\n      #.....................................................................................................\n      mrg_walk_par_rows_cfg:\n        dsk:              null\n      #.....................................................................................................\n      mrg_register_dsk_cfg:\n        dsk:              null\n        path:             null\n        url:              null\n      #.....................................................................................................\n      mrg_set_active_cfg:\n        dsk:              null\n        oln:              null\n        trk:              null\n        pce:              null\n\n  #---------------------------------------------------------------------------------------------------------\n  constructor: ( cfg ) ->\n    @cfg    = { @constructor.C.defaults.constructor_cfg..., cfg..., }\n    GUY.props.hide @, 'types', types\n    @types.validate.constructor_cfg @cfg\n    { db, } = GUY.obj.pluck_with_fallback @cfg, null, 'db'\n    GUY.props.hide @, 'db', db\n    @cfg    = GUY.lft.freeze @cfg\n    @db.create_stdlib()\n    @_set_variables?()\n    @_create_sql_functions?()\n    @_compile_sql?()\n    @_procure_infrastructure?()\n    return undefined\n\n  #---------------------------------------------------------------------------------------------------------\n  _set_variables: ->\n\n  #---------------------------------------------------------------------------------------------------------\n  _create_sql_functions: ->\n    { prefix } = @cfg\n    #-------------------------------------------------------------------------------------------------------\n    @db.create_function\n      name:           prefix + '_re_is_blank'\n      deterministic:  true\n      varargs:        false\n      call:           ( txt ) -> if ( /^\\s*$/.test txt ) then 1 else 0\n    #-------------------------------------------------------------------------------------------------------\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _procure_infrastructure: ->\n    ### TAINT skip if tables found ###\n    { prefix } = @cfg\n    @db SQL\"\"\"\n      drop view   if exists #{prefix}_rwnmirror;\n      drop view   if exists #{prefix}_parlnrs0;\n      drop view   if exists #{prefix}_parlnrs;\n      drop view   if exists #{prefix}_lines;\n      drop view   if exists #{prefix}_location_from_dsk_locid;\n      drop view   if exists #{prefix}_prv_nxt_xtra_from_dsk_locid;\n      drop table  if exists #{prefix}_locs;\n      drop table  if exists #{prefix}_mirror;\n      drop table  if exists #{prefix}_datasources;\"\"\"\n    #-------------------------------------------------------------------------------------------------------\n    # TABLES\n    #.......................................................................................................\n    @db SQL\"\"\"\n      create table #{prefix}_datasources (\n          dsk     text not null,\n          path    text,\n          url     text,\n          digest  text default null,\n        primary key ( dsk ) );\"\"\"\n    #.......................................................................................................\n    ### TAINT need to indicate column nr for fine-grained source locations ###\n    @db SQL\"\"\"\n      -- * mirrors actual file contents and records computed changes\n      -- * is format-agnostic\n      create table #{prefix}_mirror (\n          dsk     text    not null,                         -- data source key\n          oln     integer not null,                         -- original line nr (1-based)\n          trk     integer not null default 1,               -- track number\n          pce     integer not null default 1,               -- piece number\n          act     boolean not null default 1,               -- true: active, false: deleted\n          mat     boolean not null generated always as (\n            not #{prefix}_re_is_blank( txt ) ) virtual,     -- material, i.e. non-blank\n          txt     text    not null,\n        foreign key ( dsk ) references #{prefix}_datasources,\n        primary key ( dsk, oln, trk, pce ) );\"\"\"\n    #.......................................................................................................\n    @db SQL\"\"\"\n      -- Same as `mrg_mirror`, but with row numbers *for active rows*\n      create view #{prefix}_rwnmirror as select\n          row_number() over w as rwn,\n          *\n        from #{prefix}_mirror\n        where act\n        window w as ( order by dsk, oln, trk, pce )\n        order by dsk, oln, trk, pce;\"\"\"\n    #.......................................................................................................\n    @db SQL\"\"\"\n      -- Same as `mrg_rwnmirror` but only active, material lines (i.e. no lines that are deactivated\n      -- and/or blank), with PARagraph numbers added (for the technique ised here see [Gaps &\n      -- Islands](https://github.com/loveencounterflow/gaps-and-islands#the-gaps-and-islands-pattern).\n      create view #{prefix}_parlnrs0 as select\n          rwn - ( dense_rank() over w ) + 1 as par,\n          *\n        from #{prefix}_rwnmirror\n        where act and mat\n        window w as ( partition by dsk order by rwn )\n        order by rwn;\"\"\"\n    #.......................................................................................................\n    @db SQL\"\"\"\n      -- First (`rwn1`) and last (`rwn2`) RoW Number of each (WS-delimited) `par`agraph.\n      create view #{prefix}_parlnrs as select\n          dsk         as dsk,\n          par         as par,\n          min( rwn )  as rwn1,\n          max( rwn )  as rwn2\n        from #{prefix}_parlnrs0\n        group by par\n        order by rwn1;\"\"\"\n    #.......................................................................................................\n    @db SQL\"\"\"\n      -- Same as `mrg_mirror` but with PARagraph numbers added.\n      create view #{prefix}_parmirror as select\n          dsk                                                   as dsk,\n          oln                                                   as oln,\n          trk                                                   as trk,\n          pce                                                   as pce,\n          act                                                   as act,\n          mat                                                   as mat,\n          ( select\n                p.par as par\n              from #{prefix}_parlnrs as p\n              where m.rwn between p.rwn1 and p.rwn2 limit 1 )   as par,\n          txt                                                   as txt\n        from #{prefix}_rwnmirror as m\n        order by rwn;\"\"\"\n    # #.......................................................................................................\n    # @db SQL\"\"\"\n    #   -- needs variables 'dsk'\n    #   create view #{prefix}_lines as select distinct\n    #       r1.dsk                                              as dsk,\n    #       r1.oln                                              as oln,\n    #       r1.par                                              as par,\n    #       coalesce( group_concat( r1.txt, '' ) over w, '' )   as txt\n    #     from #{prefix}_parmirror as r1\n    #     where true\n    #       and ( r1.dsk = std_getv( 'dsk' ) )\n    #       and ( r1.act )\n    #     window w as (\n    #       partition by r1.oln\n    #       order by r1.oln, r1.trk, r1.pce\n    #       range between unbounded preceding and unbounded following );\"\"\"\n    # #.......................................................................................................\n    # @db SQL\"\"\"\n    #   -- needs variables 'dsk'\n    #   create view #{prefix}_pars as select distinct\n    #       r1.dsk                                                                    as dsk,\n    #       r2.oln1                                                                   as oln1,\n    #       r2.oln2                                                                   as oln2,\n    #       r1.par                                                                    as par,\n    #       coalesce( group_concat( r1.txt, char( 10 ) ) over w, '' ) || char( 10 )   as txt\n    #     from #{prefix}_parmirror as r1\n    #     join #{prefix}_parlnrs as r2 using ( dsk, par )\n    #     where true\n    #       and ( r1.dsk = std_getv( 'dsk' ) )\n    #       and ( r1.act )\n    #     window w as (\n    #       partition by r1.par\n    #       order by r1.oln, r1.trk, r1.pce\n    #       range between unbounded preceding and unbounded following );\"\"\"\n    # #-------------------------------------------------------------------------------------------------------\n    # TRIGGERS\n    #.......................................................................................................\n    @db SQL\"\"\"\n      create trigger #{prefix}_before_delete_on_mirror before delete on #{prefix}_mirror\n        begin\n          select case when old.trk = 1 and not std_getv( 'allow_change_on_mirror' ) then\n          raise( fail, '^mirage@1^ not allowed to modify table #{prefix}_mirror for trk = 1' ) end;\n          end;\"\"\"\n    @db SQL\"\"\"\n      create trigger #{prefix}_before_insert_on_mirror before insert on #{prefix}_mirror\n        begin\n          select case when new.trk = 1 and not std_getv( 'allow_change_on_mirror' ) then\n          raise( fail, '^mirage@2^ not allowed to modify table #{prefix}_mirror for trk = 1' ) end;\n          end;\"\"\"\n    @db SQL\"\"\"\n      create trigger #{prefix}_before_update_on_mirror before update on #{prefix}_mirror\n        begin\n          select case when old.trk = 1 and not std_getv( 'allow_change_on_mirror' ) then\n          raise( fail, '^mirage@3^ not allowed to modify table #{prefix}_mirror for trk = 1' ) end;\n          end;\"\"\"\n    #.......................................................................................................\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _compile_sql: ->\n    { prefix } = @cfg\n    #.......................................................................................................\n    GUY.props.hide @, 'sql',\n      #.....................................................................................................\n      get_db_object_count:  SQL\"\"\"\n        select count(*) as count from sqlite_schema where starts_with( $name, $prefix || '_' );\"\"\"\n      #.....................................................................................................\n      ds_entry_from_dsk:  SQL\"\"\"\n        select * from #{prefix}_datasources where dsk = $dsk;\"\"\"\n      #.....................................................................................................\n      update_digest: SQL\"\"\"\n        update #{prefix}_datasources set digest = $digest where dsk = $dsk;\"\"\"\n      #.....................................................................................................\n      delete_lines: SQL\"\"\"\n        delete from #{prefix}_mirror where dsk = $dsk;\"\"\"\n      #.....................................................................................................\n      upsert_datasource: @db.create_insert {\n        into:   prefix + '_datasources',\n        fields: [ 'dsk', 'path', 'url', ],\n        on_conflict: { update: true, }, }\n      #.....................................................................................................\n      insert_line: @db.create_insert {\n        into:       prefix + '_mirror',\n        fields:     [ 'dsk', 'oln', 'txt', ], }\n      #.....................................................................................................\n      insert_lnpart: @db.create_insert {\n        into:       prefix + '_mirror',\n        fields:     [ 'dsk', 'oln', 'trk', 'pce', 'txt', ], }\n      #.....................................................................................................\n      insert_xtra: @db.create_insert {\n        into:       prefix + '_mirror',\n        fields:     [ 'dsk', 'oln', 'pce', 'xtra', 'txt', ],\n        returning:  '*', }\n      #.....................................................................................................\n      insert_xtra_using_dsk_locid: SQL\"\"\"\n        -- needs variables 'dsk', 'locid'\n        -- unfortunately, got to repeat the `std_assert()` call here\n        insert into #{prefix}_mirror ( dsk, oln, pce, xtra, txt )\n          select\n              $dsk                                                    as dsk,\n              std_assert(\n                oln,\n                '^insert_xtra_using_dsk_locid@546^' ||\n                ' unknown locid ' || quote( std_getv( 'locid' ) ) )   as oln,\n              pce                                                     as pce,\n              nxt_xtra                                                as nxt_xtra,\n              $txt                                                    as txt\n            from #{prefix}_prv_nxt_xtra_from_dsk_locid\n          returning *;\"\"\"\n      #.....................................................................................................\n      insert_locid: @db.create_insert {\n        into:       prefix + '_locs',\n        fields:     [ 'dsk', 'oln', 'pce', 'props', 'del', ], }\n    #.......................................................................................................\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  register_dsk: ( cfg ) ->\n    validate.mrg_register_dsk_cfg cfg\n    if cfg.path?                              then  cfg.url   = @_url_from_path cfg.path\n    else if @types.isa.mrg_file_url cfg.url   then  cfg.path  = @_path_from_url cfg.url\n    else                                            cfg.path  = null\n    @db @sql.upsert_datasource, cfg\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _ds_entry_from_dsk: ( dsk ) -> @db.single_row @sql.ds_entry_from_dsk, { dsk, }\n  _update_digest: ( dsk, digest ) -> @db @sql.update_digest, { dsk, digest, }\n  _delete_lines: ( dsk ) -> @db @sql.delete_lines, { dsk, }\n\n  #-----------------------------------------------------------------------------------------------------------\n  _url_from_path: ( path ) ->\n    validate.mrg_fspath_for_url path\n    return ( URL.pathToFileURL path ).href\n\n  #-----------------------------------------------------------------------------------------------------------\n  _path_from_url: ( url  ) ->\n    return URL.fileURLToPath url\n\n  #---------------------------------------------------------------------------------------------------------\n  refresh_datasource: ( cfg ) ->\n    @db.setv 'allow_change_on_mirror', 1\n    try\n      R = @_refresh_datasource cfg\n    finally\n      @db.setv 'allow_change_on_mirror', 0\n    return R\n\n  #---------------------------------------------------------------------------------------------------------\n  _refresh_datasource: ( cfg ) ->\n    validate.mrg_refresh_datasource_cfg ( cfg = { @constructor.C.defaults.mrg_refresh_datasource_cfg..., cfg..., } )\n    { dsk\n      force       } = cfg\n    { prefix      } = @cfg\n    { path\n      url\n      digest      } = @_ds_entry_from_dsk dsk\n    unless path?\n      throw new Error \"^Mirage/refresh_datasource@1^ unable to refresh datasource #{rpr dsk} (URL: #{rpr url})\"\n    current_digest  = GUY.fs.get_content_hash path\n    counts          = { files: 0, bytes: 0, }\n    #.......................................................................................................\n    if force or ( digest isnt current_digest )\n      #.....................................................................................................\n      @db =>\n        @_delete_lines dsk\n        insert_line   = @db.prepare @sql.insert_line\n        oln           = 0\n        #...................................................................................................\n        for line from GUY.fs.walk_lines path, { decode: false, }\n          oln++\n          counts.bytes   += line.length\n          txt             = line.toString 'utf-8'\n          insert_line.run { dsk, oln, txt, }\n        #...................................................................................................\n        counts.files++\n        @_update_digest dsk, current_digest\n        return null\n    #.......................................................................................................\n    return counts\n\n\n  #=========================================================================================================\n  # CONTENT RETRIEVAL\n  #---------------------------------------------------------------------------------------------------------\n  get_text:       ( cfg ) -> ( d.line for d from @walk_line_rows cfg ).join '\\n'\n  get_line_rows:  ( cfg ) -> [ ( @walk_line_rows cfg )..., ]\n\n  #---------------------------------------------------------------------------------------------------------\n  walk_line_rows: ( cfg ) ->\n    validate.mrg_walk_line_rows_cfg ( cfg = { @constructor.C.defaults.mrg_walk_line_rows_cfg..., cfg..., } )\n    { dsk       } = cfg\n    { prefix    } = @cfg\n    @db.setv 'dsk',       dsk\n    return @db SQL\"select * from #{prefix}_lines;\"\n\n  #---------------------------------------------------------------------------------------------------------\n  walk_par_rows: ( cfg ) ->\n    validate.mrg_walk_par_rows_cfg ( cfg = { @constructor.C.defaults.mrg_walk_par_rows_cfg..., cfg..., } )\n    { dsk       } = cfg\n    { prefix    } = @cfg\n    @db.setv 'dsk',       dsk\n    return @db SQL\"select * from #{prefix}_pars;\"\n\n  #---------------------------------------------------------------------------------------------------------\n  activate:   ( cfg ) -> @_set_active { cfg..., act: true, }\n  deactivate: ( cfg ) -> @_set_active { cfg..., act: false, }\n\n  #---------------------------------------------------------------------------------------------------------\n  _set_active: ( cfg ) ->\n    validate.mrg_set_active_cfg ( cfg = { @constructor.C.defaults.mrg_set_active_cfg..., cfg..., } )\n    { dsk\n      oln\n      trk\n      pce\n      act } = cfg\n    act     = if act then 1 else 0\n    sql     = SQL\"update mrg_mirror set act = $act where ( dsk = $dsk )\"\n    sql    += SQL\" and ( oln = $oln )\" if oln?\n    sql    += SQL\" and ( trk = $trk )\" if trk?\n    sql    += SQL\" and ( pce = $pce )\" if pce?\n    sql    += SQL\";\"\n    ( @db.prepare sql ).run { dsk, oln, trk, pce, act, }\n    return null\n\n  #=========================================================================================================\n  # CONTENT MANIPULATION\n  #---------------------------------------------------------------------------------------------------------\n  # append_to_loc: ( cfg ) ->\n    # validate.mrg_append_to_loc_cfg ( cfg = { @constructor.C.defaults.mrg_append_to_loc_cfg..., cfg..., } )\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"
  ]
}